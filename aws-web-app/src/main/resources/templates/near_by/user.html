<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Near-By-Home</title>
    <div th:replace="~{fragments/header}"></div>
</head>
<body>
<div id="app" class="container">
    <div id="main-content">
        <div>
            <div>
                <label id="greeting"></label>
            </div>
            <form>
                <div>
                    <label>User will received message</label>
                    <input type="text" id="name" placeholder="User will receive the message...">
                </div>
                <button id="send" type="submit">Send</button>
            </form>
        </div>
    </div>
    <div>
        <label>Message from someone: </label><span id="message"></span>
    </div>
</div>
</body>
<div th:replace="~{fragments/footer}"></div>
<script type="text/javascript">
    $(document).ready(function () {
        let user = Util.getUserProfile();
        if(!Util.isUndefined(user)) {
            $("#greeting").text("Hello: " + user.fullName)
        }
        STOMP_NEAR_BY.activate();
    });

    const STOMP_NEAR_BY = new StompJs.Client({
        brokerURL: 'ws://localhost:8080/ws/near-by/ws-location',
        connectHeaders: {
            'Id-Token': Util.getLoginAuth().idToken,
            'Access-Token': Util.getLoginAuth().accessToken,
        },
        debug: function (str) {
            console.log(str);
        },
        reconnectDelay: 5000,
        heartbeatIncoming: 15000,
        heartbeatOutgoing: 15000
    });

    STOMP_NEAR_BY.onConnect = (frame) => {
        console.log('Connected: ' + frame);
        STOMP_NEAR_BY.subscribe('/users/queue/messages', function(message) {
            $("#message").text(message.body);
        });
    };

    STOMP_NEAR_BY.onWebSocketError = (error) => {
        console.error('Error with websocket', error);
    };

    STOMP_NEAR_BY.onStompError = (frame) => {
        console.error('Broker reported error: ' + frame.headers['message']);
        console.error('Additional details: ' + frame.body);
    };

    $(function() {
        $("form").on('submit', function(e) {
            e.preventDefault();
        });
        $("#send").click(function() {
            let payload = {
                'toUser': $("#name").val()
            }
            STOMP_NEAR_BY.publish({destination: '/app/greeting', body: JSON.stringify(payload) });
        });
    });
</script>
</html>