<footer>
    <span>Message Count: </span><span id="counter" onclick="test();">0</span>
    <ul id="globalMsg">
    </ul>
    <script type="text/javascript">
        function test() {
            alert($("#globalMsg").find("li").length);
        }
        $(document).ready(function () {
            checkAuth();
        });

        function checkAuth() {
            let isLogin = true;
            if (isNeedCheckAuth()) {
                let login = localStorage.getItem(CONST_LOGIN_STORAGE);
                if (Util.isUndefined(login)) isLogin = false;
            }
            if (!isLogin) {
                window.location.href = '/auth/login';
            } else {
                connectGlobalNotified();
            }
        }

        function isNeedCheckAuth() {
            let currentPath = window.location.pathname;
            if (currentPath == "/auth/login" || currentPath == "/auth/register") return false;
            return true;
        }

        const STOMP_GLOBAL = new StompJs.Client({
            brokerURL: 'ws://localhost:8080/ws/rtm/ws-system',
            connectHeaders: {
                'Id-Token': Util.getLoginAuth().idToken,
                'Access-Token': Util.getLoginAuth().accessToken,
            },
            debug: function (str) {
                console.log(str);
            },
            reconnectDelay: 5000,
            heartbeatIncoming: 15000,
            heartbeatOutgoing: 15000
        });

        STOMP_GLOBAL.onConnect = (frame) => {
            console.log('Connected: ' + frame);
            STOMP_GLOBAL.subscribe('/topic/global', (msg) => {
                // msg
                let tagMsg = $("<li></li>").text(msg.body);
                $("#globalMsg").append(tagMsg);
                // counter
                let counter = $("#counter").text();
                $("#counter").text(parseInt(counter) + 1);
            });
        };

        STOMP_GLOBAL.onWebSocketError = (error) => {
            console.error('Error with websocket', error);
        };

        STOMP_GLOBAL.onStompError = (frame) => {
            console.error('Broker reported error: ' + frame.headers['message']);
            console.error('Additional details: ' + frame.body);
        };

        function connectGlobalNotified() {
            STOMP_GLOBAL.activate();
        }

        function disconnectSystemNotified() {
            STOMP_GLOBAL.deactivate();
            console.log("Disconnected");
        }
    </script>
</footer>